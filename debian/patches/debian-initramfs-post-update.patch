Description: Run bootloader hooks from /etc/initramfs/post-update.d after making
 the image, and add $NO_POST_UPDATE_HOOKS to disable this
 .
 See <https://kernel-team.pages.debian.net/kernel-handbook/ch-update-hooks.html#s-initramfs-hooks>
Author: наб <nabijaczleweli@nabijaczleweli.xyz>
Bug-Debian: https://bugs.debian.org/753752
Forwarded: not-needed
Last-Update: 2022-11-17

diff --git a/dracut.sh b/dracut.sh
index 1edcb97..a320130 100755
--- a/dracut.sh
+++ b/dracut.sh
@@ -2733,4 +2733,10 @@ if [[ -d $dracutsysrootdir/run/systemd/system ]]; then
     fi
 fi
 
+# Invoke policy-conformant bootloader hooks
+if [ -z "$NO_POST_UPDATE_HOOKS" ] && [ -d /etc/initramfs/post-update.d/ ]; then
+    run-parts --arg="${kernel}" --arg="${outfile}" \
+        /etc/initramfs/post-update.d/
+fi
+
 exit 0
diff --git a/man/dracut.8.asc b/man/dracut.8.asc
index 1aea4d6..ef9d718 100644
--- a/man/dracut.8.asc
+++ b/man/dracut.8.asc
@@ -707,6 +707,10 @@ _DRACUT_INSTALL_LOG_LEVEL_::
 Default:
     _DRACUT_LOG_LEVEL_
 
+_NO_POST_UPDATE_HOOKS_::
+    do not run bootloader hooks residing in _/etc/initramfs/post-update.d_
+    on the resulting image
+
 FILES
 -----
 _/var/log/dracut.log_::
